<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>承認画面</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <script th:src="@{/js/main.js}"></script>
</head>
<body>
<header>
    <div class="header-contents">
        <div class="admin-header">
            <div class="header-links">
                <a class="btn-home" th:href="@{/}">HOME</a>
            </div>
            <div>
                社員番号：<span class="login-user" th:text="${loginUser.account}"></span>
            </div>
        </div>
    </div>
</header>

<main>
    <div class="main-contents">
        <h1 class="title">申請一覧</h1>
        <form th:method="put" th:action="@{/approval}" class="approval-form">
            <div class="error-global">
                <div th:if="${errorMessages != null}" th:each="errorMessage : ${errorMessages}" th:text="${errorMessage}"></div>
            </div>
            <!-- CSRFトークン -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div class="application-status">
                <p th:text="${year + '年' + month + '月分の申請'}"></p>
            </div>

            <div th:if="${#lists.isEmpty(approvalUsers)}">
                <p style="color: blue; font-weight: bold;">申請はありません</p>
            </div>

            <div th:unless="${#lists.isEmpty(approvalUsers)}">
                <div class="select-all-wrapper">
                    <label>
                        <input type="checkbox" onclick="toggleAll(this)"> 全ユーザーを確認済みにする
                    </label>
                </div>

                <div class="approval-users"
                     th:each="approvalUser : ${approvalUsers}"
                     th:if="${loginUser.departmentId == approvalUser.departmentId}">
                    <section class="approval-user-section">
                        <div class="select-wrapper">
                            <input type="checkbox"
                                   class="toggle-user"
                                   th:attr="data-user-id=${approvalUser.id}"
                                   onclick="toggleUser(this)"> 確認済み
                        </div>
                        <table class="user-basic-info-table">
                            <tbody>
                            <tr>
                                <th>社員番号</th>
                                <td><span class="user-account" th:text="${approvalUser.account}"></span></td>
                            </tr>
                            <tr>
                                <th>氏名</th>
                                <td><span class="user-name" th:text="${approvalUser.name}"></span></td>
                            </tr>
                            <tr>
                                <th>部署</th>
                                <td>
                                    <span class="user-department" th:switch="${approvalUser.departmentId}">
                                      <span th:case="1">人事部</span>
                                      <span th:case="2">営業部</span>
                                      <span th:case="3">技術部</span>
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>所定勤務時間</th>
                                <td>
                                    <span class="user-work-time" th:text="${approvalUser.workStart}"></span> ~
                                    <span class="user-work-time" th:text="${approvalUser.workEnd}"></span>
                                </td>
                            </tr>
                            <tr>
                                <th>所定休憩時間</th>
                                <td>
                                    <span class="user-rest-time" th:text="${approvalUser.restStart}"></span> ~
                                    <span class="user-rest-time" th:text="${approvalUser.restEnd}"></span>
                                </td>
                            </tr>
                            <!-- 月間合計行（別テーブルでレイアウト整える） -->
                            <tr>
                                <th colspan="2">
                                    <p th:text="${year + '年' + month + '月分 合計'}" style="margin: 0;"></p>
                                    <table class="monthly-summary-table">
                                        <thead>
                                        <tr>
                                            <th>休憩時間</th>
                                            <th>労働時間</th>
                                            <th>超過時間</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="totalDto : ${totalDtoList}" th:if="${totalDto.userId == approvalUser.id}">
                                            <td th:text="${totalDto.totalRestTimeFormatted}"></td>
                                            <td th:text="${totalDto.totalWorkTimeFormatted}"></td>
                                            <td th:text="${totalDto.totalOverTimeFormatted}"></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </th>
                            </tr>
                            </tbody>
                        </table>

                        <details class="attendance-details">
                            <summary>勤怠詳細を表示</summary>
                            <table class="attendance-table">
                                <thead>
                                <tr>
                                    <th>日付</th>
                                    <th>出勤</th>
                                    <th>退勤</th>
                                    <th>休憩開始</th>
                                    <th>休憩終了</th>
                                    <th>ステータス</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="approvalAttendance : ${approvalAttendances}"
                                    th:if="${approvalUser.id == approvalAttendance.user.id}"
                                    th:class="'user-' + ${approvalAttendance.user.id}">

                                    <input type="checkbox"
                                           name="approvedIds"
                                           class="hidden-checkbox"
                                           th:value="${approvalAttendance.id}"
                                           th:checked="${approvalAttendance.approved}"
                                           th:attr="data-user-id=${approvalAttendance.user.id}">
                                    <td th:text="${approvalAttendance.workDate}"></td>
                                    <td th:text="${approvalAttendance.startTime}"></td>
                                    <td th:text="${approvalAttendance.endTime}"></td>
                                    <td th:text="${approvalAttendance.startRest}"></td>
                                    <td th:text="${approvalAttendance.endRest}"></td>
                                    <td th:text="${approvalAttendance.statusLabel}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </details>
                    </section>
                </div>

                <div class="form-actions fixed-actions">
                    <button type="submit" name="action" value="approve" class="btn-approve">承認</button>
                    <button type="submit" name="action" value="reject" class="btn-reject">差戻</button>
                </div>
            </div>
        </form>
    </div>
</main>

<footer>
</footer>

<script>
    // ページ全体の全選択
    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('input[name="approvedIds"]');
        checkboxes.forEach(cb => cb.checked = source.checked);

        const userCheckboxes = document.querySelectorAll('.toggle-user');
        userCheckboxes.forEach(ucb => ucb.checked = source.checked);
    }

    // ユーザーごとの全選択
    function toggleUser(source) {
        const userId = source.getAttribute('data-user-id');
        const checkboxes = document.querySelectorAll(`input[name="approvedIds"][data-user-id="${userId}"]`);
        checkboxes.forEach(cb => cb.checked = source.checked);
    }

     // フォーム送信時の確認ダイアログ表示
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('.approval-form');

        form.addEventListener('submit', (event) => {
            const action = event.submitter?.value;

            if (action === 'approve') {
                if (!confirm('選択した申請を承認しますか？')) {
                    event.preventDefault();
                }
            } else if (action === 'reject') {
                if (!confirm('選択した申請を差戻しますか？')) {
                    event.preventDefault();
                }
            }
        });
    });
</script>

</body>
</html>