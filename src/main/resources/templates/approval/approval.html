<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>承認画面</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <script th:src="@{/js/main.js}"></script>
</head>
<body>
<header>
    <div class="header-contents">
        <div class="header" th:if="${loginUser != null}">
            <div>
                社員番号：<span class="login-user" th:text="${loginUser.account}"></span>
            </div>
        </div>
        <div class="header-links">
            <a class="btn-home" th:href="@{/}">HOME</a>
        </div>
    </div>
</header>

<main>
    <div class="main-container">
        <form th:method="put" th:action="@{/approval}" class="approval-form">

            <div class="select-all-wrapper">
                <label>
                    <input type="checkbox" onclick="toggleAll(this)"> 全ユーザーの全選択
                </label>
            </div>

            <div class="approval-users" th:each="approvalUser : ${approvalUsers}">
                <section class="approval-user-section">

                    <div class="user-basic-info">
                        <span class="user-account" th:text="${approvalUser.account}">ユーザー名</span>
                        <span class="user-name" th:text="${approvalUser.name}">氏名</span>
                        <span class="user-department" th:text="${approvalUser.departmentId}">部署</span>
                        <span class="user-work-time" th:text="${approvalUser.workStart}">勤務開始時間</span> -
                        <span class="user-work-time" th:text="${approvalUser.workEnd}">勤務終了時間</span>
                        <span class="user-rest-time" th:text="${approvalUser.restStart}">休憩開始時間</span> -
                        <span class="user-rest-time" th:text="${approvalUser.restEnd}">休憩終了時間</span>
                    </div>

                    <details class="attendance-details">
                        <summary>勤怠情報を表示</summary>
                        <table class="attendance-table">
                            <thead>
                            <tr>
                                <th>
                                    <input type="checkbox"
                                           class="toggle-user"
                                           th:attr="data-user-id=${approvalUser.id}"
                                           onclick="toggleUser(this)"> ユーザー全選択
                                </th>
                                <th>日付</th>
                                <th>出勤</th>
                                <th>退勤</th>
                                <th>休憩開始</th>
                                <th>休憩終了</th>
                                <th>ステータス</th>
                                <th>コメント</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="approvalAttendance : ${approvalAttendances}"
                                th:if="${approvalUser.id == approvalAttendance.user.id}"
                                th:class="'user-' + ${approvalAttendance.user.id}">
                                <td>
                                    <input type="checkbox"
                                           name="approvedIds"
                                           th:value="${approvalAttendance.id}"
                                           th:checked="${approvalAttendance.approved}"
                                           th:attr="data-user-id=${approvalAttendance.user.id}">
                                </td>
                                <td th:text="${approvalAttendance.workDate}"></td>
                                <td th:text="${approvalAttendance.startTime}"></td>
                                <td th:text="${approvalAttendance.endTime}"></td>
                                <td th:text="${approvalAttendance.startRest}"></td>
                                <td th:text="${approvalAttendance.endRest}"></td>
                                <td th:text="${approvalAttendance.statusLabel}"></td>
                                <td>
                                    <input type="hidden" name="attendanceIds" th:value="${approvalAttendance.id}">
                                    <input type="text" name="comment" th:value="${approvalAttendance.comment}">
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </details>
                </section>
            </div>

            <div class="form-actions">
                <button type="submit" name="action" value="approve">承認</button>
                <button type="submit" name="action" value="apply">申請</button>
            </div>
        </form>
    </div>
</main>

<footer>
    <div class="footer-container">
        <form th:action="@{/}">
            <input type="submit" value="戻る">
        </form>
    </div>
</footer>

<script>
    // ページ全体の全選択
    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('input[name="approvedIds"]');
        checkboxes.forEach(cb => cb.checked = source.checked);

        const userCheckboxes = document.querySelectorAll('.toggle-user');
        userCheckboxes.forEach(ucb => ucb.checked = source.checked);
    }

    // ユーザーごとの全選択
    function toggleUser(source) {
        const userId = source.getAttribute('data-user-id');
        const checkboxes = document.querySelectorAll(`input[name="approvedIds"][data-user-id="${userId}"]`);
        checkboxes.forEach(cb => cb.checked = source.checked);
    }
</script>

</body>
</html>