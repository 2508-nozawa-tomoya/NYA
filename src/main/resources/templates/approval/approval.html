<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>承認画面</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <script th:src="@{/js/main.js}"></script>
</head>
<body>
<header>
    <div class="header-contents">
        <div class="admin-header">
            <div class="header-links">
                <a class="btn-home" th:href="@{/}">HOME</a>
            </div>
            <div>
                社員番号：<span class="login-user" th:text="${loginUser.account}"></span>
            </div>
        </div>
    </div>
</header>

<main>
    <div class="main-contents">
        <h1 class="title">申請一覧</h1>
        <form th:method="put" th:action="@{/approval}" class="approval-form">
            <div class="errorMessages">
                <div th:if="${errorMessages != null}" th:each="errorMessage : ${errorMessages}" th:text="${errorMessage}"></div>
            </div>
            <!-- CSRFトークン -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

            <div th:if="${#lists.isEmpty(approvalUsers)}">
                <p>申請はありません</p>
            </div>

            <div th:unless="${#lists.isEmpty(approvalUsers)}">
                <div class="select-all-wrapper">
                    <label>
                        <input type="checkbox" onclick="toggleAll(this)"> 全ユーザー選択
                    </label>
                </div>

                <div class="approval-users" th:each="approvalUser : ${approvalUsers}" th:if="${loginUser.departmentId == approvalUser.departmentId}">
                    <section class="approval-user-section">

                        <table class="user-basic-info-table">
                            <tbody>
                            <tr>
                                <th>ユーザー名</th>
                                <td><span class="user-account" th:text="${approvalUser.account}"></span></td>
                            </tr>
                            <tr>
                                <th>氏名</th>
                                <td><span class="user-name" th:text="${approvalUser.name}"></span></td>
                            </tr>
                            <tr>
                                <th>部署</th>
                                <td><span class="user-department" th:text="${approvalUser.departmentId}"></span></td>
                            </tr>
                            <tr>
                                <th>勤務時間</th>
                                <td>
                                    <span class="user-work-time" th:text="${approvalUser.workStart}"></span> -
                                    <span class="user-work-time" th:text="${approvalUser.workEnd}"></span>
                                </td>
                            </tr>
                            <tr>
                                <th>休憩時間</th>
                                <td>
                                    <span class="user-rest-time" th:text="${approvalUser.restStart}"></span> -
                                    <span class="user-rest-time" th:text="${approvalUser.restEnd}"></span>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                        <details class="attendance-details">
                            <summary>勤怠情報を表示</summary>
                            <table class="attendance-table">
                                <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox"
                                               class="toggle-user"
                                               th:attr="data-user-id=${approvalUser.id}"
                                               onclick="toggleUser(this)"> 全選択
                                    </th>
                                    <th>日付</th>
                                    <th>出勤</th>
                                    <th>退勤</th>
                                    <th>休憩開始</th>
                                    <th>休憩終了</th>
                                    <th>ステータス</th>
                                    <th>コメント</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="approvalAttendance : ${approvalAttendances}"
                                    th:if="${approvalUser.id == approvalAttendance.user.id}"
                                    th:class="'user-' + ${approvalAttendance.user.id}">
                                    <td>
                                        <input type="checkbox"
                                               name="approvedIds"
                                               th:value="${approvalAttendance.id}"
                                               th:checked="${approvalAttendance.approved}"
                                               th:attr="data-user-id=${approvalAttendance.user.id}">
                                    </td>
                                    <td th:text="${approvalAttendance.workDate}"></td>
                                    <td th:text="${approvalAttendance.startTime}"></td>
                                    <td th:text="${approvalAttendance.endTime}"></td>
                                    <td th:text="${approvalAttendance.startRest}"></td>
                                    <td th:text="${approvalAttendance.endRest}"></td>
                                    <td th:text="${approvalAttendance.statusLabel}"></td>
                                    <td>
                                        <input type="hidden" name="attendanceIds" th:value="${approvalAttendance.id}">
                                        <input type="text" name="comment" th:value="${approvalAttendance.comment}">
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </details>
                    </section>
                </div>

                <div class="form-actions fixed-actions">
                    <button type="submit" name="action" value="approve" class="btn-approve">承認</button>
                    <button type="submit" name="action" value="reject" class="btn-reject">差戻</button>
                </div>
            </div>
        </form>
    </div>
</main>

<footer>
</footer>

<script>
    // ページ全体の全選択
    function toggleAll(source) {
        const checkboxes = document.querySelectorAll('input[name="approvedIds"]');
        checkboxes.forEach(cb => cb.checked = source.checked);

        const userCheckboxes = document.querySelectorAll('.toggle-user');
        userCheckboxes.forEach(ucb => ucb.checked = source.checked);
    }

    // ユーザーごとの全選択
    function toggleUser(source) {
        const userId = source.getAttribute('data-user-id');
        const checkboxes = document.querySelectorAll(`input[name="approvedIds"][data-user-id="${userId}"]`);
        checkboxes.forEach(cb => cb.checked = source.checked);
    }

     // フォーム送信時の確認ダイアログ表示
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.querySelector('.approval-form');

        form.addEventListener('submit', (event) => {
            const action = event.submitter?.value;

            if (action === 'approve') {
                if (!confirm('選択した申請を承認しますか？')) {
                    event.preventDefault();
                }
            } else if (action === 'reject') {
                if (!confirm('選択した申請を差戻しますか？')) {
                    event.preventDefault();
                }
            }
        });
    });
</script>

</body>
</html>